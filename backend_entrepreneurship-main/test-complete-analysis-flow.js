const fetch = require('node-fetch');

const BASE_URL = 'http://localhost:3000/api/v1';

async function testCompleteAnalysisFlow() {
  console.log('üß™ [TEST] Iniciando pruebas del flujo completo de an√°lisis...\n');

  try {
    // Test 1: Verificar que el m√≥dulo no est√© completado inicialmente
    console.log('1Ô∏è‚É£ [TEST] Verificando estado inicial del m√≥dulo...');
    const initialProgressResponse = await fetch(`${BASE_URL}/business-progress/1/1`);
    console.log('‚úÖ [TEST] GET progress inicial:', initialProgressResponse.status);
    
    if (initialProgressResponse.status === 404) {
      console.log('üìä [TEST] M√≥dulo no completado (esperado)');
    }

    // Test 2: Guardar datos de an√°lisis completo con la estructura exacta del ejemplo
    console.log('\n2Ô∏è‚É£ [TEST] Guardando datos de an√°lisis completo...');
    const testAnalysisData = {
      negocioId: 1,
      moduloId: 1,
      analisisId: 1,
      costosAnalizados: [
        {
          nombre_costo: "Alquiler",
          valor_recibido: "$350",
          rango_estimado: "$500-2000/mes para No especificado en Quito sur",
          evaluacion: "‚ö†Ô∏è Dentro del rango, pero por debajo del promedio",
          comentario: "El valor de alquiler de $350 se encuentra dentro del rango esperado para un No especificado en una zona comercial/residencial de Quito sur, pero es considerablemente inferior al promedio. Esto podr√≠a indicar una ubicaci√≥n menos estrat√©gica o un contrato favorable. Se debe investigar la ubicaci√≥n y las caracter√≠sticas del local para asegurar que la baja renta no se deba a factores negativos que afecten la afluencia de clientes."
        },
        {
          nombre_costo: "Luz",
          valor_recibido: "$20",
          rango_estimado: "$50-200/mes (depende de consumo)",
          evaluacion: "‚ö†Ô∏è Por debajo del rango",
          comentario: "El costo de la luz de $20 es significativamente bajo comparado con el rango estimado. Se debe verificar el consumo real y la posibilidad de un error en la medici√≥n o facturaci√≥n. Un consumo tan bajo podr√≠a ser indicativo de un local peque√±o, pero tambi√©n podr√≠a ser un riesgo si el consumo aumenta en el futuro."
        },
        {
          nombre_costo: "Agua",
          valor_recibido: "$30",
          rango_estimado: "$20-80/mes (depende de consumo)",
          evaluacion: "‚úÖ Dentro del rango",
          comentario: "El costo del agua de $30 se encuentra dentro del rango esperado para una cafeter√≠a en Quito sur. Se recomienda monitorear el consumo para evitar aumentos inesperados."
        },
        {
          nombre_costo: "Internet",
          valor_recibido: "$40",
          rango_estimado: "$30-100/mes (depende de velocidad)",
          evaluacion: "‚úÖ Dentro del rango",
          comentario: "El costo de internet de $40 mensuales se encuentra dentro del rango promedio del mercado para Quito sur. Se recomienda revisar la velocidad del servicio contratado y la relaci√≥n costo-beneficio."
        },
        {
          nombre_costo: "Patente",
          valor_recibido: "$40",
          rango_estimado: "$100-500/a√±o (depende de actividad)",
          evaluacion: "‚ö†Ô∏è Por debajo del rango",
          comentario: "El costo anual de la patente de $40 es significativamente bajo. Se debe verificar la informaci√≥n y asegurarse de que se trata de un valor correcto y que cubre todos los requisitos legales. Es posible que se deba un pago adicional o exista un error en el c√°lculo."
        },
        {
          nombre_costo: "Permisos",
          valor_recibido: "$30",
          rango_estimado: "$200-1000/a√±o (depende de tipo de negocio)",
          evaluacion: "‚ö†Ô∏è Por debajo del rango",
          comentario: "El costo anual de los permisos de $30 es significativamente bajo. Se debe revisar exhaustivamente la documentaci√≥n y asegurarse de que se cumplen todos los requisitos legales. La discrepancia entre el valor pagado y el rango de mercado sugiere un posible riesgo legal y financiero."
        },
        {
          nombre_costo: "Seguros",
          valor_recibido: "$20",
          rango_estimado: "$50-300/mes (depende de cobertura)",
          evaluacion: "‚ö†Ô∏è Por debajo del rango",
          comentario: "El costo mensual del seguro de $20 es muy bajo. Se debe analizar la cobertura del seguro y determinar si es suficiente para proteger el negocio ante posibles riesgos. Una cobertura insuficiente puede generar p√©rdidas significativas en caso de un evento imprevisto."
        }
      ],
      riesgosDetectados: [
        {
          riesgo: "Subestimaci√≥n de Costos Legales y Regulatorios",
          causa_directa: "Los costos de patente y permisos est√°n significativamente por debajo del rango de mercado esperado.",
          probabilidad: "Alta",
          impacto: "Posibles multas o sanciones por incumplimiento de regulaciones, lo que podr√≠a afectar significativamente la rentabilidad del negocio.",
          consecuencias: "Multas y sanciones que podr√≠an superar considerablemente el valor real de los permisos y patentes, generando un impacto financiero negativo significativo."
        },
        {
          riesgo: "Cobertura de Seguro Insuficiente",
          causa_directa: "El costo del seguro es extremadamente bajo en comparaci√≥n con el rango de mercado.",
          probabilidad: "Alta",
          impacto: "Posible incapacidad para cubrir p√©rdidas significativas en caso de un evento imprevisto (incendio, robo, etc.), lo que podr√≠a llevar a la quiebra del negocio.",
          consecuencias: "P√©rdidas financieras considerables en caso de siniestro, que podr√≠an superar ampliamente el ahorro en costos de seguro."
        },
        {
          riesgo: "Aumento Inesperado de Costos de Servicios B√°sicos",
          causa_directa: "Los costos de luz y agua son anormalmente bajos.",
          probabilidad: "Media",
          impacto: "Un aumento en el consumo de servicios b√°sicos podr√≠a afectar negativamente la rentabilidad del negocio.",
          consecuencias: "Incremento de costos operativos que puede erosionar el margen de ganancia."
        }
      ],
      planAccion: [
        {
          titulo: "Auditor√≠a Urgente y Reclasificaci√≥n de Tasas de Bomberos y ARCSA",
          descripcion: "Contactar al Cuerpo de Bomberos de Quito sur para obtener el desglose y la justificaci√≥n del costo de $30 mensuales, verificando la clasificaci√≥n de riesgo de la actividad y el c√°lculo de la tasa anual. Solicitar informaci√≥n sobre posibles descuentos o exenciones por tama√±o de negocio.",
          prioridad: "Cr√≠tica",
          plazo: "Inmediato (1 semana)",
          inversion: "$0 (tiempo propio para gesti√≥n y consulta)",
          impacto_esperado: "Reducci√≥n potencial de $10-$25 mensuales ($120-$300 anuales) en la tasa de Bomberos si se identifica un error o posibilidad de descuento. Claridad sobre la necesidad de ARCSA, evitando pagos innecesarios."
        },
        {
          titulo: "Optimizaci√≥n del Costo de Internet Mediante Renegociaci√≥n o Cambio de Proveedor",
          descripcion: "Realizar un estudio de mercado comparativo de al menos 3 proveedores de internet en Quito sur (CNT, Claro, etc.), buscando planes de fibra √≥ptica empresariales con velocidades de al menos 10 Mbps, comparando precios y contratos. Contactar a los proveedores actuales para negociar una reducci√≥n de precio.",
          prioridad: "Alta",
          plazo: "1 mes",
          inversion: "$0 - $50 (costo potencial de instalaci√≥n en caso de cambio de proveedor)",
          impacto_esperado: "Ahorro proyectado de $10-$20 mensuales ($120-$240 anuales) sin comprometer la calidad del servicio, mejorando directamente el flujo de caja y la rentabilidad del negocio."
        },
        {
          titulo: "Clarificaci√≥n y Gesti√≥n Proactiva de Permisos Municipales",
          descripcion: "Obtener un desglose detallado de todos los permisos y licencias que conforman el costo mensual de $30, incluyendo la descripci√≥n completa de cada permiso, la autoridad emisora, la fecha de emisi√≥n y la fecha de vencimiento. Verificar la validez y necesidad de cada permiso.",
          prioridad: "Media",
          plazo: "2 meses",
          inversion: "$0 (tiempo propio para gesti√≥n y consulta)",
          impacto_esperado: "Mayor transparencia financiera, prevenci√≥n de pagos innecesarios y mitigaci√≥n de riesgos de multas por omisi√≥n. Potencial de ahorro de $5-$15 mensuales si se identifican permisos no obligatorios o redundantes."
        },
        {
          titulo: "Negociaci√≥n de Alquiler",
          descripcion: "Contactar al propietario del local para negociar una reducci√≥n en el costo del alquiler, presentando un argumento basado en el an√°lisis de costos y la rentabilidad actual del negocio.",
          prioridad: "Alta",
          plazo: "1-2 meses",
          inversion: "$0 (tiempo propio para gesti√≥n y negociaci√≥n)",
          impacto_esperado: "Reducci√≥n potencial en el costo de alquiler, mejorando significativamente la rentabilidad del negocio. Posible ahorro de $50-$100 mensuales."
        }
      ],
      resumenAnalisis: {
        puntuacion_global: 7,
        recomendaciones: ["Implementar seguros", "Optimizar costos", "Auditor√≠a legal", "Negociaci√≥n de alquiler"],
        conclusiones: "El negocio presenta costos operativos significativamente por debajo del mercado, lo que puede indicar tanto oportunidades de optimizaci√≥n como riesgos regulatorios importantes que requieren atenci√≥n inmediata."
      }
    };

    const saveResponse = await fetch(`${BASE_URL}/ai/save-complete-results`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(testAnalysisData)
    });

    console.log('‚úÖ [TEST] POST save-complete-results:', saveResponse.status);
    
    if (saveResponse.ok) {
      const saveResult = await saveResponse.json();
      console.log('üìä [TEST] Datos guardados exitosamente');
      console.log('üìä [TEST] ID del resultado:', saveResult.data?.resultadoId);
    } else {
      const errorText = await saveResponse.text();
      console.log('‚ùå [TEST] Error al guardar:', errorText);
    }

    // Test 3: Marcar m√≥dulo como completado
    console.log('\n3Ô∏è‚É£ [TEST] Marcando m√≥dulo como completado...');
    const completeResponse = await fetch(`${BASE_URL}/business-progress/1/1/complete`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      }
    });

    console.log('‚úÖ [TEST] PUT complete:', completeResponse.status);
    
    if (completeResponse.ok) {
      const completeResult = await completeResponse.json();
      console.log('üìä [TEST] M√≥dulo completado exitosamente');
      console.log('üìä [TEST] Estado final:', completeResult.data?.estado);
    } else {
      const errorText = await completeResponse.text();
      console.log('‚ùå [TEST] Error al completar m√≥dulo:', errorText);
    }

    // Test 4: Verificar que el m√≥dulo est√© completado
    console.log('\n4Ô∏è‚É£ [TEST] Verificando que el m√≥dulo est√© completado...');
    const finalProgressResponse = await fetch(`${BASE_URL}/business-progress/1/1`);
    console.log('‚úÖ [TEST] GET progress final:', finalProgressResponse.status);
    
    if (finalProgressResponse.ok) {
      const finalProgress = await finalProgressResponse.json();
      console.log('üìä [TEST] Progreso final obtenido');
      console.log('üìä [TEST] ID Estado:', finalProgress.id_estado);
      console.log('üìä [TEST] Estado Nombre:', finalProgress.estado_nombre);
      
      if (finalProgress.id_estado === 3) {
        console.log('‚úÖ [TEST] M√≥dulo correctamente marcado como completado');
      } else {
        console.log('‚ö†Ô∏è [TEST] Estado inesperado:', finalProgress.id_estado);
      }
    } else {
      const errorText = await finalProgressResponse.text();
      console.log('‚ùå [TEST] Error al obtener progreso final:', errorText);
    }

    // Test 5: Recuperar datos guardados
    console.log('\n5Ô∏è‚É£ [TEST] Recuperando datos guardados...');
    const getDataResponse = await fetch(`${BASE_URL}/ai/get-complete-results/1/1`);
    console.log('‚úÖ [TEST] GET complete-results:', getDataResponse.status);
    
    if (getDataResponse.ok) {
      const retrievedData = await getDataResponse.json();
      console.log('üìä [TEST] Datos recuperados exitosamente');
      
      if (retrievedData.success && retrievedData.data) {
        console.log('‚úÖ [TEST] Estructura de datos correcta');
        console.log('üìä [TEST] Costos analizados:', retrievedData.data.costosAnalizados?.length || 0, 'elementos');
        console.log('üìä [TEST] Riesgos detectados:', retrievedData.data.riesgosDetectados?.length || 0, 'elementos');
        console.log('üìä [TEST] Plan de acci√≥n:', retrievedData.data.planAccion?.length || 0, 'elementos');
        console.log('üìä [TEST] Resumen an√°lisis:', retrievedData.data.resumenAnalisis ? 'Presente' : 'Ausente');
        
        // Verificar contenido espec√≠fico
        if (retrievedData.data.costosAnalizados?.length > 0) {
          const primerCosto = retrievedData.data.costosAnalizados[0];
          console.log('üìä [TEST] Primer costo:', primerCosto.nombre_costo, '-', primerCosto.valor_recibido);
        }
        
        if (retrievedData.data.riesgosDetectados?.length > 0) {
          const primerRiesgo = retrievedData.data.riesgosDetectados[0];
          console.log('üìä [TEST] Primer riesgo:', primerRiesgo.riesgo);
        }
        
        if (retrievedData.data.planAccion?.length > 0) {
          const primerPlan = retrievedData.data.planAccion[0];
          console.log('üìä [TEST] Primer plan:', primerPlan.titulo, '- Prioridad:', primerPlan.prioridad);
        }
      } else {
        console.log('‚ö†Ô∏è [TEST] Datos no encontrados o formato inesperado');
        console.log('üìä [TEST] Respuesta completa:', retrievedData);
      }
    } else {
      const errorText = await getDataResponse.text();
      console.log('‚ùå [TEST] Error al recuperar datos:', errorText);
    }

    console.log('\nüéâ [TEST] Flujo completo de an√°lisis probado exitosamente!');
    console.log('\nüìã [TEST] Resumen de la prueba:');
    console.log('‚úÖ Guardado de datos completos');
    console.log('‚úÖ Marcado de m√≥dulo como completado');
    console.log('‚úÖ Verificaci√≥n de estado completado');
    console.log('‚úÖ Recuperaci√≥n de datos guardados');
    console.log('‚úÖ Validaci√≥n de estructura de datos');

  } catch (error) {
    console.error('‚ùå [TEST] Error durante las pruebas:', error.message);
    console.error('‚ùå [TEST] Stack trace:', error.stack);
  }
}

// Ejecutar las pruebas
testCompleteAnalysisFlow();
