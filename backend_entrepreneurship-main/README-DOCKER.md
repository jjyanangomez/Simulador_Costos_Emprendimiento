# üê≥ Docker - Backend Simulador de Emprendimientos

## ü™ü Para Usuarios de Windows

Si est√°s en Windows, usa el script de PowerShell:

```powershell
# Ejecutar script de inicio para Windows
.\start-backend.ps1
```

O sigue la gu√≠a paso a paso manual:

```powershell
# 1. Verificar Docker Desktop est√© ejecut√°ndose
docker --version

# 2. Crear archivo .env
copy env.example .env

# 3. Instalar dependencias y compilar
npm install
npm run build

# 4. Iniciar contenedores
docker-compose up --build -d

# 5. Ver logs
docker-compose logs -f
```

---

## üìã √çndice

- [Requisitos Previos](#requisitos-previos)
- [Gu√≠a Paso a Paso](#gu√≠a-paso-a-paso)
- [Verificaci√≥n de Funcionamiento](#verificaci√≥n-de-funcionamiento)
- [Servicios Incluidos](#servicios-incluidos)
- [Configuraci√≥n](#configuraci√≥n)
- [Comandos √ötiles](#comandos-√∫tiles)
- [Troubleshooting](#troubleshooting)
- [Limpieza](#limpieza)

## üîß Requisitos Previos

Antes de comenzar, aseg√∫rate de tener instalado:

- **Docker Desktop** (Windows/Mac) o **Docker Engine** (Linux)
- **Docker Compose** (incluido en Docker Desktop)
- **Node.js** (versi√≥n 18 o superior)
- **npm** (incluido con Node.js)
- **Git** (para clonar el repositorio)

### Verificar Instalaci√≥n
```bash
# Verificar Docker
docker --version

# Verificar Docker Compose
docker-compose --version

# Verificar Node.js
node --version

# Verificar npm
npm --version
```

## üöÄ Gu√≠a Paso a Paso

### Paso 1: Preparar el Entorno

```bash
# 1. Navegar al directorio del proyecto
cd Backend

# 2. Verificar que est√©s en el directorio correcto
ls -la
# Deber√≠as ver: Dockerfile, docker-compose.yml, package.json, etc.
```

### Paso 2: Crear Archivo de Variables de Entorno

```bash
# 3. Crear archivo .env desde el ejemplo
cp env.example .env

# 4. Verificar que se cre√≥ correctamente
ls -la .env
```

### Paso 3: Instalar Dependencias

```bash
# 5. Instalar todas las dependencias de Node.js
npm install

# 6. Verificar que las dependencias se instalaron correctamente
ls -la node_modules
```

### Paso 4: Compilar la Aplicaci√≥n

```bash
# 7. Compilar el proyecto TypeScript a JavaScript
npm run build

# 8. Verificar que se cre√≥ la carpeta dist
ls -la dist/
# Deber√≠as ver: dist/src/main.js, dist/src/app.module.js, etc.
```

### Paso 5: Verificar Configuraci√≥n

```bash
# 9. Ejecutar verificaci√≥n de configuraci√≥n
./scripts/quick-check.sh

# Si no tienes permisos de ejecuci√≥n:
chmod +x scripts/*.sh
./scripts/quick-check.sh
```

**Resultado esperado:**
```
üîç [QUICK-CHECK] Verificando configuraci√≥n del backend...
‚úÖ [QUICK-CHECK] Docker encontrado
‚úÖ [QUICK-CHECK] Docker Compose encontrado
‚úÖ [QUICK-CHECK] Node.js encontrado
‚úÖ [QUICK-CHECK] npm encontrado
‚úÖ [QUICK-CHECK] Todos los archivos necesarios est√°n presentes
‚úÖ [QUICK-CHECK] Archivo .env encontrado
‚úÖ [QUICK-CHECK] Dependencias instaladas
‚úÖ [QUICK-CHECK] Aplicaci√≥n compilada
‚úÖ [QUICK-CHECK] Permisos de scripts configurados
‚úÖ [QUICK-CHECK] Puerto 3000 disponible
‚úÖ [QUICK-CHECK] Puerto 5432 disponible
‚úÖ [QUICK-CHECK] Puerto 5050 disponible
üéâ [QUICK-CHECK] Verificaci√≥n completada exitosamente
```

### Paso 6: Detener Contenedores Existentes (si los hay)

```bash
# 10. Detener cualquier contenedor que pueda estar ejecut√°ndose
docker-compose down --remove-orphans

# 11. Verificar que no hay contenedores ejecut√°ndose
docker-compose ps
```

### Paso 7: Construir e Iniciar los Contenedores

```bash
# 12. Construir e iniciar todos los servicios
docker-compose up --build -d

# 13. Verificar que los contenedores se est√°n ejecutando
docker-compose ps
```

**Resultado esperado:**
```
Name                    Command               State           Ports
--------------------------------------------------------------------------------
krakedev_backend       ./scripts/init.sh                    Up      0.0.0.0:3000->3000/tcp
krakedev_pgadmin       /entrypoint.sh                       Up      0.0.0.0:5050->80/tcp
krakedev_postgres      docker-entrypoint.sh postgres       Up      0.0.0.0:5432->5432/tcp
```

### Paso 8: Esperar a que los Servicios Est√©n Listos

```bash
# 14. Ver logs para monitorear el progreso
docker-compose logs -f

# Esperar hasta ver mensajes como:
# ‚úÖ [INIT] Base de datos lista
# ‚úÖ [INIT] Seed completado
# üöÄ [INIT] Iniciando aplicaci√≥n...
```

**‚è±Ô∏è Tiempo estimado:** 2-3 minutos para la primera ejecuci√≥n

### Paso 9: Verificar Funcionamiento

```bash
# 15. Verificar que todos los servicios est√©n funcionando
docker-compose ps

# 16. Probar la API
curl http://localhost:3000/api/v1/

# 17. Verificar Swagger
curl http://localhost:3000/api/docs
```

## ‚úÖ Verificaci√≥n de Funcionamiento

### Verificaci√≥n Autom√°tica

```bash
# Ejecutar script de verificaci√≥n de salud
./scripts/health-check.sh
```

### Verificaci√≥n Manual

| Servicio | URL | Estado Esperado |
|----------|-----|-----------------|
| **Backend API** | `http://localhost:3000/api/v1/` | Respuesta JSON |
| **Swagger Docs** | `http://localhost:3000/api/docs` | Documentaci√≥n API |
| **pgAdmin** | `http://localhost:5050` | Interfaz web |

### Credenciales pgAdmin

- **Email:** `admin@krakedev.com`
- **Password:** `admin123`

## üìã Servicios Incluidos

| Servicio | Puerto | Descripci√≥n | URL |
|----------|--------|-------------|-----|
| **Backend** | 3000 | API NestJS | `http://localhost:3000` |
| **PostgreSQL** | 5432 | Base de datos | `localhost:5432` |
| **pgAdmin** | 5050 | Gesti√≥n de BD | `http://localhost:5050` |

## üîß Configuraci√≥n

### Variables de Entorno
El archivo `.env` se crea autom√°ticamente desde `env.example` con valores por defecto:

```bash
# Base de datos
DATABASE_URL="postgresql://postgres:admin123@postgres:5432/simulador_emprendimientos?schema=public"
POSTGRES_PASSWORD=admin123

# API Keys
API_KEY="tu-api-key-de-google-ai"

# JWT
JWT_SECRET="your-secret-key-change-in-production"
```

### Personalizaci√≥n
Edita el archivo `.env` para cambiar configuraciones:
```bash
nano .env
```

## üìú Comandos √ötiles

### Gesti√≥n de Servicios
```bash
# Iniciar servicios
docker-compose up -d

# Detener servicios
docker-compose down

# Reiniciar servicios
docker-compose restart

# Ver estado
docker-compose ps

# Ver logs
docker-compose logs -f
```

### Gesti√≥n de Base de Datos
```bash
# Ejecutar migraciones manualmente
docker exec krakedev_backend npx prisma migrate deploy

# Ejecutar seed manualmente
docker exec krakedev_backend npm run seed

# Acceder a PostgreSQL
docker exec -it krakedev_postgres psql -U postgres -d simulador_emprendimientos

# Backup de base de datos
docker exec krakedev_postgres pg_dump -U postgres simulador_emprendimientos > backup.sql
```

### Desarrollo
```bash
# Entrar al contenedor del backend
docker exec -it krakedev_backend sh

# Ver logs espec√≠ficos
docker-compose logs -f backend
docker-compose logs -f postgres
docker-compose logs -f pgadmin
```

## üîç Verificaci√≥n de Salud

### Endpoints de Verificaci√≥n
- **API Principal**: `http://localhost:3000/api/v1/`
- **Documentaci√≥n Swagger**: `http://localhost:3000/api/docs`
- **pgAdmin**: `http://localhost:5050`

### Script de Verificaci√≥n
```bash
# Verificar que todo est√© funcionando
./scripts/health-check.sh
```

## üõ†Ô∏è Troubleshooting

### Problemas Comunes

#### 1. Error de conexi√≥n a la base de datos
```bash
# Verificar que PostgreSQL est√© ejecut√°ndose
docker-compose ps

# Ver logs de PostgreSQL
docker-compose logs postgres

# Verificar conectividad
docker exec krakedev_backend nc -z postgres 5432
```

#### 2. Puerto ya en uso
```bash
# Verificar puertos en uso
netstat -tulpn | grep :3000

# Cambiar puerto en .env
BACKEND_PORT=3001
```

#### 3. Error de permisos en scripts
```bash
# Hacer scripts ejecutables
chmod +x scripts/*.sh
```

#### 4. Error de memoria
```bash
# Aumentar memoria de Docker
# En Docker Desktop: Settings > Resources > Memory
```

#### 5. Error de compilaci√≥n
```bash
# Limpiar y reinstalar dependencias
rm -rf node_modules package-lock.json
npm install
npm run build
```

#### 6. Error de dependencias
```bash
# Verificar versi√≥n de Node.js
node --version

# Limpiar cache de npm
npm cache clean --force

# Reinstalar dependencias
rm -rf node_modules
npm install
```

### Logs y Debugging
```bash
# Ver logs del backend
docker-compose logs -f backend

# Ver logs de PostgreSQL
docker-compose logs -f postgres

# Ver logs de pgAdmin
docker-compose logs -f pgadmin

# Entrar al contenedor del backend
docker exec -it krakedev_backend sh

# Verificar estado de servicios
docker-compose ps
```

## üßπ Limpieza

### Limpieza Completa
```bash
# Detener y eliminar todo
docker-compose down --volumes --remove-orphans

# Limpiar im√°genes no utilizadas
docker image prune -f

# Limpiar vol√∫menes no utilizados
docker volume prune -f

# Limpiar dependencias locales
rm -rf node_modules dist
```

### Limpieza Selectiva
```bash
# Solo detener contenedores
docker-compose down

# Detener y eliminar im√°genes
docker-compose down --rmi all

# Detener y eliminar vol√∫menes
docker-compose down --volumes
```

## üìä Monitoreo

### M√©tricas de Contenedores
```bash
# Ver uso de recursos
docker stats

# Ver informaci√≥n detallada
docker inspect krakedev_backend

# Ver logs en tiempo real
docker-compose logs -f --tail=100
```

## üîí Seguridad

### Buenas Pr√°cticas
1. **Cambiar contrase√±as por defecto** en `.env`
2. **Usar secrets** para API keys en producci√≥n
3. **Limitar acceso** a pgAdmin
4. **Usar redes Docker** para aislamiento
5. **Ejecutar como usuario no-root**

### Verificaci√≥n de Seguridad
```bash
# Verificar usuario del contenedor
docker exec krakedev_backend whoami

# Verificar permisos
docker exec krakedev_backend ls -la

# Verificar variables de entorno
docker exec krakedev_backend env | grep -E "(API_KEY|JWT_SECRET)"
```

## üìù Notas Importantes

1. **Primera ejecuci√≥n**: El seed se ejecuta autom√°ticamente
2. **Persistencia**: Los datos se guardan en vol√∫menes Docker
3. **Logs**: Se muestran en tiempo real con emojis
4. **Health checks**: Verificaci√≥n autom√°tica de servicios
5. **Migraciones**: Se ejecutan autom√°ticamente al iniciar
6. **Compilaci√≥n**: Se requiere antes de ejecutar Docker

## üÜò Soporte

Si encuentras problemas:

1. Ejecuta verificaci√≥n: `./scripts/quick-check.sh`
2. Verifica los logs: `docker-compose logs -f`
3. Ejecuta health check: `./scripts/health-check.sh`
4. Revisa la configuraci√≥n en `.env`
5. Limpia y reconstruye: `docker-compose down && docker-compose up --build -d`

## üéØ Comandos de Inicio R√°pido

```bash
# 1. Instalar dependencias
npm install

# 2. Compilar aplicaci√≥n
npm run build

# 3. Verificar configuraci√≥n
./scripts/quick-check.sh

# 4. Iniciar servicios
docker-compose up --build -d

# 5. Ver logs
docker-compose logs -f

# 6. Verificar funcionamiento
curl http://localhost:3000/api/v1/

# 7. Abrir Swagger
open http://localhost:3000/api/docs
```

## üéâ ¬°Listo!

Una vez completados todos los pasos, tendr√°s:

- ‚úÖ **Backend API** funcionando en `http://localhost:3000`
- ‚úÖ **Base de datos PostgreSQL** con datos de prueba
- ‚úÖ **pgAdmin** para gesti√≥n de base de datos
- ‚úÖ **Documentaci√≥n Swagger** completa
- ‚úÖ **Datos de prueba** incluidos autom√°ticamente

¬°Tu backend est√° completamente dockerizado y listo para usar!
